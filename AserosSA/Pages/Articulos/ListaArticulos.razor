@page "/listaArticulos"

@inject IJSRuntime JsRuntime
@using System.ComponentModel
@using Models
@inject ModalService _modalService
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager NavigationManager


<div class="col-sm-12" style="text-align:left;margin-top:10px;">
    <h3>Articulos</h3>
</div>
<div>
    <Row Style="margin-bottom:10px;" Justify="end">
        <Col Span="3">
        <Select DataSource="@_list"
                @bind-Value="@_selectedValue1"
                ValueName="@nameof(CriteriodeBusqueda.Value)"
                LabelName="@nameof(CriteriodeBusqueda.Name)"
                DisabledName="@nameof(CriteriodeBusqueda.IsDisabled)"
                Style="width:120px"
                OnSelectedItemChanged="OnSelectedItemChangedHandler">
        </Select>
        </Col>
        <Col Span="9">
        <Search EnterButton="true" OnSearch="buscar" @bind-Value="@txtValue" Placeholder="Buscar" />
        </Col>
        <Col Span="3">
        <div style="text-align:right; width:87%;">
            <a @onclick="AltaArticulo" title="Nuevo"><i style="margin-right:5px;">Agregar</i><span class="oi oi-plus"></span></a>
        </div>
        </Col>
    </Row>
</div>


<Table @ref="table"
       TItem="ArticuloModel"
       DataSource="@articulos"
       Total="_total"
       @bind-PageIndex="_pageIndex"
       @bind-PageSize="_pageSize"
       Size=@TableSize.Small
       @bind-SelectedRows="selectedRows">

    <AntDesign.Column @bind-Field="@context.Id" Sortable />
    <AntDesign.Column @bind-Field="@context.Nombre" Sortable />
    <AntDesign.Column @bind-Field="@context.Descripcion" Sortable />
    <AntDesign.Column @bind-Field="@context.Marca" Sortable />
    <AntDesign.Column @bind-Field="@context.Cantidad" Sortable />
    <AntDesign.Column @bind-Field="@context.PrecioUnitario" Sortable />
    <AntDesign.Column @bind-Field="@context.Minimo" Sortable />
    <AntDesign.Column @bind-Field="@context.Maximo" Sortable />
    <AntDesign.Column @bind-Field="@context.PuntoReorden" Sortable />
    <AntDesign.Column TData="string" DataIndex="Unidad.Id" Sortable />
    <AntDesign.Column TData="string" DataIndex="Ubicacion.Id" Sortable />
    <AntDesign.Column TData="string" DataIndex="Almacen.Id" Sortable />

    <ActionColumn>
        <Space>
            <a href="/consultaArticulo/1" title="Ver">
                <span class="oi oi-eye"></span>
            </a>
        </Space>
    </ActionColumn>
    <ActionColumn>
        <Space>
            <a href="/altaArticulo/1" title="Editar">
                <span class="oi oi-pencil"></span>
            </a>
        </Space>
    </ActionColumn>
    <ActionColumn>
        <Space>
            <a title="Eliminar" @onclick="Eliminar">
                <span class="oi oi-trash"></span>
            </a>
        </Space>
    </ActionColumn>
</Table>

<br />
<p>Página: @_pageIndex | Registros: @_pageSize | Total: @_total</p>





@code {

    CasosDeUso[] casoDeUso;

    IEnumerable<ArticuloModel> selectedRows;
    ITable table;

    int _pageIndex = 1;
    int _pageSize = 5;
    int _total = 0;

    List<ArticuloModel> articulos = null;
    List<CriteriodeBusqueda> _list;
    string _selectedValue1;

    protected override async Task OnInitializedAsync()
    {
        casoDeUso = await GetForecastAsync(_pageIndex, _pageSize);
        _total = casoDeUso.Length;

        _list = new List<CriteriodeBusqueda>{
            new CriteriodeBusqueda {Value = "Clave", Name = "Clave"},
            new CriteriodeBusqueda {Value = "Descripción", Name = "Descripción"}
        };

        articulos = new List<ArticuloModel> {
            new ArticuloModel{Id = "ART-01", Nombre = "Hojas blancas", Descripcion="Paquete de hojas blancas t/carta", Marca = "Scribe",
                Cantidad = 40, PrecioUnitario = 70.00, Minimo = 30, Maximo = 150, PuntoReorden = 50,
                Unidad = new UnidadModel{Id = "", Simbolo="Caj", Descripcion = "Caja de Cartón", Estatus = "activo" },
                Almacen = new AlmacenModel{ Id = "ALM-PRUE-00", Nombre = "Almacen" , Descripcion ="Almacen de prueba", Status ="Activo"},
                //Ubicacion = new UbicacionModel{Id = 1, Estante = "1" , Zona = 3}
            }
        };
    }

    class CriteriodeBusqueda
    {
        public string Value { get; set; }
        public string Name { get; set; }
        public bool IsDisabled { get; set; }
    }

    private void OnSelectedItemChangedHandler(CriteriodeBusqueda value)
    {
        Console.WriteLine($"selected: ${value?.Name}");
    }

    public class CasosDeUso
    {
        public int Id { get; set; }

        [DisplayName("Clave")]
        public string? ClavePrincipal { get; set; }

        [DisplayName("Descripcion")]
        public string Descripcion { get; set; }

        [DisplayName("Marca")]
        public string Marca { get; set; }

        [DisplayName("Maximo")]
        public string Maximo { get; set; }

        [DisplayName("Punto de Reorden")]
        public string PuntoReorden { get; set; }

        [DisplayName("Minimo")]
        public string Minimo { get; set; }

    }

    private static readonly string[] ClavesPrincipales = new[]
    {
        "100-PAP-001-PZA", "150-CLV-002-PZA", "200-PAP-001-PZA", "250-CLV-002-PZA", "300-PAP-001-PZA", "350-CLV-002-PZA", "400-PAP-001-PZA"
    };
    private static readonly string[] Descripciones = new[]
    {
        "ACETATOS", "GALVANIZADOS"
    };
    private static readonly string[] Marcas = new[]
    {
        "IMPERIAL", "POP", "HILLMAN", "ARROW", "MEGA"
    };
    private static readonly string[] Maximos = new[]
    {
        "2,000", "3,000", "4,000", "5,000", "Media"
    };
    private static readonly string[] PuntosReordenes = new[]
    {
         "100", "150", "200", "250", "300", "350", "400", "450", "500", "550", "600"
    };
    private static readonly string[] Minimos = new[]
    {
        "100", "200", "300"
    };

    public Task<CasosDeUso[]> GetForecastAsync(int pageIndex, int pageSize)
    {
        var rng = new Random();
        return Task.FromResult(Enumerable.Range((pageIndex - 1) * pageSize + 1, 11).Select(index =>
        {

            return new CasosDeUso
            {
                Id = index,
                ClavePrincipal = ClavesPrincipales[rng.Next(ClavesPrincipales.Length)],
                Descripcion = Descripciones[rng.Next(Descripciones.Length)],
                Marca = Marcas[rng.Next(Marcas.Length)],
                Maximo = Maximos[rng.Next(Maximos.Length)],
                PuntoReorden = PuntosReordenes[rng.Next(PuntosReordenes.Length)],
                Minimo = Minimos[rng.Next(Minimos.Length)],
            };
        }).ToArray());
    }

    public async Task AltaArticulo()
    {
        await localStorage.SetItemAsync<List<ArticuloModel>>("Articulos", articulos);
        NavigationManager.NavigateTo("altaArticulo");
    }


    public async Task Eliminar()
    {
        //await JsRuntime.InvokeAsync<string>(identifier: "cancelSwal");
        var isTrue = await _modalService.ConfirmAsync(new ConfirmOptions()
        {
            Title = "Elimar",
            Icon =@<Icon Type="exclamation-circle" Theme="Outline"></Icon>,
Content = "¿Estas seguro que deseas eliminar este articulo?",
OkText = "Si",
CancelText = "Cancelar"
});

if (isTrue)
NavigationManager.NavigateTo("/listaArticulos");
}
private string txtValue { get; set; }
private async Task buscar()
{
await JsRuntime.InvokeAsync<object>(identifier: "swal", $"Bucando...{txtValue}");
}
}

